"""
Settings and configuration management
"""

import os
from typing import Optional
from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    """
    Application settings with environment variable support
    """
    
    # Airflow Configuration
    AIRFLOW_HOME: str = os.getenv('AIRFLOW_HOME', '/opt/airflow')
    DAGS_FOLDER: str = os.getenv('AIRFLOW__CORE__DAGS_FOLDER', '/opt/airflow/dags')
    
    # Database Configuration
    POSTGRES_HOST: str = os.getenv('POSTGRES_HOST', 'localhost')
    POSTGRES_PORT: int = int(os.getenv('POSTGRES_PORT', '5432'))
    POSTGRES_USER: str = os.getenv('POSTGRES_USER', 'airflow')
    POSTGRES_PASSWORD: str = os.getenv('POSTGRES_PASSWORD', 'airflow')
    POSTGRES_DB: str = os.getenv('POSTGRES_DB', 'airflow')
    
    # Data Warehouse Configuration
    DATA_WAREHOUSE_HOST: str = os.getenv('DATA_WAREHOUSE_HOST', 'localhost')
    DATA_WAREHOUSE_PORT: int = int(os.getenv('DATA_WAREHOUSE_PORT', '5432'))
    DATA_WAREHOUSE_USER: str = os.getenv('DATA_WAREHOUSE_USER', 'dw_user')
    DATA_WAREHOUSE_PASSWORD: str = os.getenv('DATA_WAREHOUSE_PASSWORD', 'dw_password')
    DATA_WAREHOUSE_DB: str = os.getenv('DATA_WAREHOUSE_DB', 'data_warehouse')
    
    # Executor Configuration
    EXECUTOR: str = os.getenv('AIRFLOW__CORE__EXECUTOR', 'LocalExecutor')
    PARALLELISM: int = int(os.getenv('AIRFLOW__CORE__PARALLELISM', '4'))
    MAX_ACTIVE_TASKS_PER_DAG: int = int(os.getenv('AIRFLOW__CORE__MAX_ACTIVE_TASKS_PER_DAG', '3'))
    
    # External Services
    EXTERNAL_API_ENDPOINT: str = os.getenv('EXTERNAL_API_ENDPOINT', 'https://api.example.com/v1')
    API_TIMEOUT: int = int(os.getenv('API_TIMEOUT', '30'))
    
    # Email Configuration
    SMTP_HOST: str = os.getenv('AIRFLOW__SMTP__SMTP_HOST', 'smtp.gmail.com')
    SMTP_PORT: int = int(os.getenv('AIRFLOW__SMTP__SMTP_PORT', '587'))
    SMTP_USER: str = os.getenv('AIRFLOW__SMTP__SMTP_USER', '')
    SMTP_PASSWORD: str = os.getenv('AIRFLOW__SMTP__SMTP_PASSWORD', '')
    
    # Slack Configuration (optional)
    SLACK_WEBHOOK_URL: Optional[str] = os.getenv('SLACK_WEBHOOK_URL', None)
    
    # Pipeline Configuration
    BATCH_SIZE: int = int(os.getenv('BATCH_SIZE', '1000'))
    MIN_EXTRACTION_RECORDS: int = int(os.getenv('MIN_EXTRACTION_RECORDS', '1'))
    DATA_QUALITY_THRESHOLD: float = float(os.getenv('DATA_QUALITY_THRESHOLD', '0.95'))
    
    # Environment
    ENVIRONMENT: str = os.getenv('ENVIRONMENT', 'development')
    DEBUG: bool = os.getenv('DEBUG', 'false').lower() == 'true'
    
    class Config:
        env_file = '.env'
        case_sensitive = True
    
    @property
    def postgres_connection_string(self) -> str:
        """Generate PostgreSQL connection string"""
        return (
            f"postgresql+psycopg2://{self.POSTGRES_USER}:{self.POSTGRES_PASSWORD}"
            f"@{self.POSTGRES_HOST}:{self.POSTGRES_PORT}/{self.POSTGRES_DB}"
        )
    
    @property
    def dw_connection_string(self) -> str:
        """Generate Data Warehouse connection string"""
        return (
            f"postgresql+psycopg2://{self.DATA_WAREHOUSE_USER}:{self.DATA_WAREHOUSE_PASSWORD}"
            f"@{self.DATA_WAREHOUSE_HOST}:{self.DATA_WAREHOUSE_PORT}/{self.DATA_WAREHOUSE_DB}"
        )


# Create global settings instance
_settings: Optional[Settings] = None


def get_settings() -> Settings:
    """
    Get or create settings instance (singleton pattern)
    
    Returns:
        Settings instance
    """
    global _settings
    if _settings is None:
        _settings = Settings()
    return _settings


def reload_settings() -> Settings:
    """Force reload settings from environment"""
    global _settings
    _settings = Settings()
    return _settings
